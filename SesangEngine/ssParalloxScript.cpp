#include "ssParalloxScript.h"
#include "ssMeshRenderer.h"
#include "ssResources.h"
#include "ssGameObject.h"
#include "ssAnimator.h"
#include "ssMonster.h"
#include "ssSceneManager.h"
#include "ssBackground.h"
#include "ssPlayer.h"
#define NOMINMAX
#include <windows.h>
#include <algorithm>





namespace ss
{
	ParalloxScript::ParalloxScript()
		: mFirst(false)
		, mSpeed(false)
		, mMinX(0.f)
		, mMaxX(0.f)
		, mMinY(0.f)
		, mMaxY(0.f)

	{		
	}

	ParalloxScript::~ParalloxScript()
	{
	}

	void ParalloxScript::Initialize()
	{
		MeshRenderer* mr = GetOwner()->GetComponent<MeshRenderer>();
		Transform* tr = GetOwner()->GetComponent<Transform>();

		
		// 배경마다 크기가 다르므로 아래처럼 해준다.
		if (GetOwner()->GetName() == L"HowlingEffectObj")
		{
			tr->SetScale(Vector3(583.f, 123.f, 0.f));

		}
	}

	void ParalloxScript::Update()
	{
		Transform* Playertr = mPlayer->GetComponent<Transform>();

		Transform* Layertr = GetOwner()->GetComponent<Transform>();

		// mPlayer를 담아주는 코드 전에 AddComponent를 했더니 해당 스크립트의 Initalize를 먼저 돌아버려서
		// mPlayer이 nullptr인 상태로 오기 땜에 initalize가 아닌 update에서 해줌 

		if (mFirst) // 플레이어의 처음 위치 
		{
			mPlayerPrePos = Playertr->GetPosition();
			mFirst = true; 
		}
		
		
		// 플레이어의 실시간 위치 
		mPlayerCurPos = Playertr->GetPosition();
		
		// 움직임 계산
		Vector3 characterMovement = mPlayerCurPos - mPlayerPrePos;


		if (GetOwner()->GetName() == L"BG_Moon"
			|| GetOwner()->GetName() == L"BG_Tree1"
			|| GetOwner()->GetName() == L"BG_Tree2"
			|| GetOwner()->GetName() == L"BG_Tree3"
			|| GetOwner()->GetName() == L"BG_Tree4")
		{

			// 배경 레이어 새 위치 계산 (배경 레이어들 속도는 
			// (가장 먼 배경은 최대 1로, 가장 가까운건 최소 0에 가깝게)) 
			Vector3 LayerNewPos = Layertr->GetPosition() + (characterMovement * mSpeed);


			// 새 위치가 경계 값을 넘어가지 않도록 체크
			LayerNewPos.x = (std::max)(mMinX, (std::min)(mMaxX, LayerNewPos.x));
			LayerNewPos.y = (std::max)(mMinY, (std::min)(mMaxY, LayerNewPos.y));
	
			Layertr->SetPosition(LayerNewPos);



			
		}

		//// 배경 레이어들의 속도 설정
		//float backgroundLayer1Speed = 0.5f; // 가장 먼 배경
		//float backgroundLayer2Speed = 0.7f;
		//float backgroundLayer3Speed = 1.0f; // 가장 가까운 배경



		// 실시간 위치 구한 후, 이전 위치 실시간 갱신 
		mPlayerPrePos = mPlayerCurPos;

	}

	void ParalloxScript::OnCollisionEnter(Collider2D* other)
	{
	}

	void ParalloxScript::OnCollisionStay(Collider2D* other)
	{
	}

	void ParalloxScript::OnCollisionExit(Collider2D* other)
	{
	}
}
